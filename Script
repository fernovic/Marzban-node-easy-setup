#!/bin/bash

# نمایش منو
show_menu() {
    echo "1. Update server"
    echo "2. Install Marzban Node"
    echo "3. Block Iran"
    echo "4. Install custom Xray"
    echo "5. Install Network Manager"
    echo "6. Auto-restart Marzban Node"
    echo "7. Auto-restart Server"
    echo "8. Exit"
}

# بروزرسانی سرور
update_server() {
    echo "Updating server..."
    sudo apt update && sudo apt upgrade -y
}

# نصب Marzban Node
install_marzban_node() {
    echo "Installing Marzban Node..."
    
    # نصب پیش‌نیازها
    sudo apt-get install -y docker.io docker-compose

    # دانلود Marzban Node
    git clone https://github.com/fernovic/Marzban-node.git /root/Marzban-node

    # ورود به مسیر
    cd /root/Marzban-node/

    # اجرای docker-compose
    docker-compose up -d
}

# فعالسازی بلاک ایران
block_iran() {
    echo "Do you want to enable the Iran block? (yes/no)"
    read enable_iran_block

    if [[ "$enable_iran_block" == "yes" ]]; then
        # ایجاد دایرکتوری برای فایل‌های assets
        mkdir -p /var/lib/marzban/assets/

        # دانلود فایل‌های بلاک ایران
        wget -O /var/lib/marzban/assets/geosite.dat https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat
        wget -O /var/lib/marzban/assets/geoip.dat https://github.com/v2fly/geoip/releases/latest/download/geoip.dat
        wget -O /var/lib/marzban/assets/iran.dat https://github.com/bootmortis/iran-hosted-domains/releases/latest/download/iran.dat

        # ویرایش فایل docker-compose.yml
        cd /root/Marzban-node/
        sed -i '/volumes:/a \      - /var/lib/marzban:/var/lib/marzban\n      - /var/lib/marzban/assets:/usr/local/share/xray' docker-compose.yml

        # راه‌اندازی مجدد کانتینر
        docker compose down && docker compose up -d

        echo "Iran block enabled!"
    else
        echo "Iran block not enabled."
    fi
}

# نصب ورژن دلخواه Xray
install_custom_xray() {
    echo "Do you want to install the latest Xray version? (yes/no)"
    read install_latest_xray

    # نصب unzip در صورت نیاز
    if ! command -v unzip &>/dev/null; then
        sudo apt-get install -y unzip
    fi

    # ویرایش فایل docker-compose.yml
    cd /root/Marzban-node/
    sed -i 's/# XRAY_EXECUTABLE_PATH: "/var/lib/marzban/xray-core/xray"/XRAY_EXECUTABLE_PATH: "/var/lib/marzban/xray-core/xray"/' docker-compose.yml

    if [[ "$install_latest_xray" == "yes" ]]; then
        wget https://github.com/XTLS/xray-core/releases/latest/download/Xray-linux-64.zip
    else
        echo "Enter the download link for the desired Xray version:"
        read xray_link
        wget $xray_link -O Xray-linux-64.zip
    fi

    unzip Xray-linux-64.zip
    rm Xray-linux-64.zip

    # راه‌اندازی مجدد Docker
    docker compose down && docker compose up -d
}

# نصب Network Manager و تنظیم کرون‌جاب
install_network_manager() {
    echo "Installing Network Manager..."
    sudo apt-get install network-manager -y

    echo "Do you want to restart NetworkManager periodically? (yes/no)"
    read restart_network_cron

    if [[ "$restart_network_cron" == "yes" ]]; then
        echo "Enter the hour interval (e.g., */4 for every 4 hours):"
        read hour_interval

        (crontab -l ; echo "0 $hour_interval * * * systemctl restart NetworkManager") | crontab -

        echo "Cron job set to restart NetworkManager every $hour_interval hours."
    fi
}

# ریستارت خودکار نود مرزبان
auto_restart_node() {
    echo "Creating run_docker.sh script to restart Marzban Node..."
    echo -e "#!/bin/bash\n\ncd /root/Marzban-node\n\ndocker compose down && docker compose up -d" > /root/run_docker.sh
    sudo chmod +x /root/run_docker.sh

    echo "Do you want to restart Marzban Node periodically? (yes/no)"
    read restart_node_cron

    if [[ "$restart_node_cron" == "yes" ]]; then
        echo "Enter the hour interval (e.g., */4 for every 4 hours):"
        read hour_interval

        (crontab -l ; echo "0 $hour_interval * * * /root/run_docker.sh > /dev/null 2>&1") | crontab -

        echo "Cron job set to restart Marzban Node every $hour_interval hours."
    fi
}

# ریستارت خودکار سرور
auto_restart_server() {
    echo "Do you want to restart the server periodically? (yes/no)"
    read restart_server_cron

    if [[ "$restart_server_cron" == "yes" ]]; then
        echo "Enter the hour interval (e.g., */6 for every 6 hours):"
        read hour_interval

        (crontab -l ; echo "0 $hour_interval * * * /sbin/shutdown -r now") | crontab -

        echo "Cron job set to restart the server every $hour_interval hours."
    fi
}

# حلقه منو برای اجرای گزینه‌ها
while true; do
    show_menu
    read -p "Select an option [1-8]: " option
    case $option in
        1) update_server ;;
        2) install_marzban_node ;;
        3) block_iran ;;
        4) install_custom_xray ;;
        5) install_network_manager ;;
        6) auto_restart_node ;;
        7) auto_restart_server ;;
        8) exit ;;
        *) echo "Invalid option!" ;;
    esac
done
