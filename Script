#!/bin/bash

# نمایش منو برای کاربر
show_menu() {
    echo "1. Update server"
    echo "2. Install Marzban Node"
    echo "3. Block Iran"
    echo "4. Install custom Xray"
    echo "5. Install Network Manager"
    echo "6. Auto-restart Marzban Node"
    echo "7. Auto-restart Server"
    echo "8. Exit"
}

# آپدیت سرور
update_server() {
    sudo apt update && sudo apt upgrade -y
}

# نصب Marzban Node
install_marzban_node() {
    git clone --recurse-submodules https://github.com/Gozargah/Marzban-node.git
    cd Marzban-node
    cp docker-compose.override.yml.example docker-compose.override.yml
    docker compose up -d
    cd ..
}

# تنظیم پورت‌ها در docker-compose.yml
set_ports() {
    read -p "Enter SERVICE_PORT (default: 5000): " SERVICE_PORT
    SERVICE_PORT=${SERVICE_PORT:-5000}

    read -p "Enter XRAY_API_PORT (default: 5001): " XRAY_API_PORT
    XRAY_API_PORT=${XRAY_API_PORT:-5001}

    # ویرایش فایل `docker-compose.yml`
    sed -i "s/SERVICE_PORT:.*/SERVICE_PORT: $SERVICE_PORT/" Marzban-node/docker-compose.yml
    sed -i "s/XRAY_API_PORT:.*/XRAY_API_PORT: $XRAY_API_PORT/" Marzban-node/docker-compose.yml

    # ری‌استارت کردن Docker Compose
    cd Marzban-node
    docker compose down
    docker compose up -d
    cd ..
}

# فعال‌سازی Block Iran
block_iran() {
    cd Marzban-node

    # اضافه کردن خطوط به volumes
    sed -i '/volumes:/a \      - /var/lib/marzban:/var/lib/marzban\n      - /var/lib/marzban/assets:/usr/local/share/xray' docker-compose.yml

    # ایجاد دایرکتوری و دانلود فایل‌ها
    mkdir -p /var/lib/marzban/assets/
    wget -O /var/lib/marzban/assets/geosite.dat https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat
    wget -O /var/lib/marzban/assets/geoip.dat https://github.com/v2fly/geoip/releases/latest/download/geoip.dat
    wget -O /var/lib/marzban/assets/iran.dat https://github.com/bootmortis/iran-hosted-domains/releases/latest/download/iran.dat

    # ری‌استارت Docker Compose
    docker compose down
    docker compose up -d
    cd ..
}

# نصب ورژن دلخواه Xray
install_custom_xray() {
    sudo apt install -y unzip
    cd Marzban-node

    # فعال‌سازی XRAY_EXECUTABLE_PATH در `docker-compose.yml`
    sed -i 's/# XRAY_EXECUTABLE_PATH/XRAY_EXECUTABLE_PATH/' docker-compose.yml

    echo "Choose installation option:"
    echo "1. Install latest Xray version"
    echo "2. Install custom Xray version"
    read -p "Enter choice: " choice

    if [[ "$choice" == "1" ]]; then
        wget https://github.com/XTLS/xray-core/releases/latest/download/Xray-linux-64.zip
    elif [[ "$choice" == "2" ]]; then
        read -p "Enter Xray download link: " xray_link
        wget "$xray_link"
    else
        echo "Invalid option!"
        return
    fi

    unzip Xray-linux-64.zip
    rm Xray-linux-64.zip

    # ری‌استارت Docker Compose
    docker compose down
    docker compose up -d
    cd ..
}

# نصب Network Manager و تنظیم کرون‌جاب
install_network_manager() {
    sudo apt-get install -y network-manager
    read -p "Do you want to restart NetworkManager periodically? (yes/no): " response
    if [[ "$response" == "yes" ]]; then
        read -p "Enter interval (hours, default: 1): " interval
        interval=${interval:-1}
        (crontab -l 2>/dev/null; echo "0 */$interval * * * systemctl restart NetworkManager") | crontab -
    fi
}

# تنظیم ری‌استارت خودکار نود مرزبان
auto_restart_node() {
    echo -e "#!/bin/bash\ncd Marzban-node\ndocker compose down && docker compose up -d" > /root/run_docker.sh
    sudo chmod +x /root/run_docker.sh

    read -p "Enter interval (hours, default: 4): " interval
    interval=${interval:-4}
    (crontab -l 2>/dev/null; echo "0 */$interval * * * /root/run_docker.sh >/dev/null 2>&1") | crontab -

    echo "You can manually restart Marzban Node with: /root/run_docker.sh"
}

# تنظیم ری‌استارت خودکار سرور
auto_restart_server() {
    read -p "Enter interval (hours, default: 6): " interval
    interval=${interval:-6}
    (crontab -l 2>/dev/null; echo "0 */$interval * * * /sbin/shutdown -r now") | crontab -
}

# اجرای منو در حلقه
while true; do
    show_menu
    read -p "Select an option [1-8]: " option
    case $option in
        1) update_server ;;
        2) install_marzban_node; set_ports ;;
        3) block_iran ;;
        4) install_custom_xray ;;
        5) install_network_manager ;;
        6) auto_restart_node ;;
        7) auto_restart_server ;;
        8) exit ;;
        *) echo "Invalid option!" ;;
    esac
done
